@model Sistema_OT.ViewModels.OrdenConAvancesViewModel
@{
    ViewData["Title"] = "VistaIndividual";
    var activeSection = ViewBag.ActiveSection;
    var nombresUsuarios = ViewData["NombresUsuarios"] as Dictionary<int, string>;
    var nombresSistemas = ViewData["NombresSistemas"] as Dictionary<int, string>;
    var nombresClientes = ViewData["NombresClientes"] as Dictionary<int, string>;
    var nombresProyectos = ViewData["NombresProyectos"] as Dictionary<int, string>;
    var ordentrabajo = ViewData["Orden"] as List<Dictionary<string, object>>;
    var avancesTrabajo = ViewData["Avances_Trabajo"] as List<Sistema_OT.Models.AvancesTrabajoModel>;
    var historial= ViewData["HistorialEstados"] as List<Sistema_OT.Models.HistorialdeEstadoModel>;

    var adjuntos = ViewData["Adjuntos"] as List<Sistema_OT.Models.ArchivoAdjuntoModel>;
    var nroOrden = ViewBag.NroOrdenTrabajo;

    var estados = ViewData["Estados"] as List<Sistema_OT.Models.HistorialdeEstadoModel>;
    var transiciones = ViewData["Transiciones"] as List<Sistema_OT.Models.HistorialdeEstadoModel>;
    var orden = ViewData["Orden"] as List<Dictionary<string, object>>;


    int estadoActual = 0;

    if (orden != null)
    {
        var estadoStr = orden.FirstOrDefault()?["Estado"]?.ToString()?.Trim();
        bool esNumero = int.TryParse(estadoStr, out int temp);
        if (esNumero)
        {
            estadoActual = temp;
        }
        else
        {
            estadoActual = estados.FirstOrDefault(e => e.Descripcion == estadoStr)?.Estado ?? 0;
        }
    }


    // Obtener la descripción del estado actual para mostrar texto
    var descripcionEstadoActual = estados.FirstOrDefault(e => e.Estado == estadoActual)?.Descripcion ?? "Desconocido";

    // Obtener los estados siguientes permitidos
    var estadosSiguientes = estados
        .Where(e => transiciones.Any(t => t.EstadoOrigen == estadoActual && t.EstadoDestino == e.Estado))
        .ToList();


}



<!-- jQuery y Bootstrap JS (con Popper) y bootstrap -->
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link rel="stylesheet" href="~/css/VistaIndividual.css" />
<!-- Incluir el archivo RTFJS desde un CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/rtfjs/1.0.0/rtf.min.js"></script>

<!-- Incluir tu archivo site.js -->
<script src="~/js/site.js"></script>

<input type="hidden" id="nombresSistemas" value='@Html.Raw(Json.Serialize(nombresSistemas))' />
<input type="hidden" id="nombresClientes" value='@Html.Raw(Json.Serialize(nombresClientes))' />


<!-- Contenedor principal para el formulario Individual-->
<div class="container" -fluid mt-3" style="width: 100% ; max-width: 2600px; margin: 0 auto;">
    <div class="row">
        <div class="col-12">
            <!-- Tarjeta con el formulario -->
            <div class="card shadow-sm">
                <div class="btn btn secondary; card-header bg-info text-white">
                    <h5 class="mb-0">Individual - MODIFICACION OT N°  @nroOrden </h5>
                </div>

                @if (TempData["MensajeExito"] != null)
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        @TempData["MensajeExito"]
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                }

                @if (TempData["MensajeError"] != null)
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        @TempData["MensajeError"]
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                }


                <form asp-action="ActualizarOrden" asp-controller="ABM" method="post">


                      <div class="card-body">



                                    <div style="font-size: 12px" class="row row-cols-3 g-3">
                                        <!-- Primera fila con campos de la orden -->
                                        <!-- Campo de Orden -->

                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label for="NroOrdenTrabajo">Orden</label>
                                                    <input readonly type="number" class="form-control" style="font-size:12px;" id="NroOrdenTrabajo"
                                                           placeholder="Ingrese el número" name="NroOrdenTrabajo" value="@nroOrden" />
                                                </div>
                                            </div>

                                        <!-- Campo de Dependencia -->
                                        <div class="col-md-1">
                                            <div class="form-group">
                                                <label for="dependencia" class="text-nowrap">Depende</label>
                                    <input type="text" class="form-control" style="font-size:12px;" id="Depende" placeholder="Depende de.." name="Depende" value="@ordentrabajo?.FirstOrDefault()?["DependeDe"]" />

                                            </div>
                                        </div>

                                        <!-- Campo Fecha de Solicitud -->
                                        <div class="col-md-2">
                                            <div class="form-group">
                                                <label for="fechaSolicitud">Fecha de Solicitud</label>
                                    <input type="date" class="form-control" style="font-size:12px;" id="FechaSolicitud" name="FechaSolicitud" value="@ordentrabajo?.FirstOrDefault()?["FechaSolicitud"]" />
                                            </div>
                                        </div>
                                        <!-- Campo Fecha de Vencimiento -->
                                        <div class="col-md-2">
                                            <div class="form-group">
                                                <label for="fechaVencimiento">Fecha de Vencimiento</label>
                                    <input readonly type="date" class="form-control" style="font-size:12px;" id="FechaVencimiento" name="FechaVencimiento" value="@ordentrabajo?.FirstOrDefault()?["FechaVencimiento"]" />
                                            </div>
                                        </div>
                                        <!-- Campo Estado del Trabajo -->
                            <!-- Estado actual (solo informativo, no editable) -->
                            @* Campo oculto para obtener el valor del estado actual en JS *@
                            <input type="hidden" id="estadoActualHidden" name="EstadoActual" value="@estadoActual" />

                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Estado Actual: <strong>@descripcionEstadoActual</strong> Cambiar a:</label>
                                    <select class="form-select" id="nuevoEstado" name="EstadoDescripcion" style="font-size:12px;">
                                       @*  <option value="">Seleccione nuevo estado</option> *@
                                        @foreach (var estado in estadosSiguientes)
                                        {
                                            <option value="@estado.Estado">@estado.Descripcion</option>
                                        }
                                    </select>
                                </div>
                            </div>

                            <script>
                                const estados = {
                                    1: "PENDIENTE",
                                    2: "ENTREGADO",
                                    3: "EN DESARROLLO",
                                    4: "TERMINADO",
                                    5: "EN PRODUCCION",
                                    6: "ANULADA",
                                    7: "FACTURADA",
                                    8: "BONIFICADA",
                                    9: "PRESUPUESTO ENVIADO AL CLIENTE",
                                    10: "PRUEBA REALIZADA OK",
                                    11: "PARA REVISAR PROBLEMAS EN LAS PRUEBAS",
                                    12: "PRESUPUESTO APROBADO",
                                    13: "PRESUPUESTO ASIGNADO",
                                    14: "PRESUPUESTO NO APROBADO",
                                    15: "FACTURADA (INCLUIDA ABONO)",
                                    16: "EN PROCESO DE PRESUPUESTO",
                                    17: "PRESUPUESTO FACTURADO",
                                    18: "INCLUIDA EN VERSION"
                                };

                                const transiciones = {
                                    1: [2, 3, 6, 16],
                                    2: [3],
                                    3: [4],
                                    4: [5, 9, 10, 11],
                                    5: [7, 8, 15],
                                    9: [12, 14],
                                    10: [5, 18],
                                    11: [3],
                                    12: [13],
                                    13: [17],
                                    14: [12],
                                    16: [4, 6, 9],
                                    18: [5]
                                };

                                document.addEventListener("DOMContentLoaded", function () {
                                    const nuevoEstadoSelect = document.getElementById("nuevoEstado");
                                    const estadoActual = parseInt(document.getElementById("estadoActualHidden").value);

                                    function cargarEstadosDisponibles(estadoOrigen) {
                                        nuevoEstadoSelect.innerHTML = '<option value="">Seleccione</option>';

                                        const posibles = transiciones[estadoOrigen] || [];

                                        posibles.forEach(destino => {
                                            const option = document.createElement("option");
                                            option.value = destino;
                                            option.text = estados[destino];
                                            nuevoEstadoSelect.appendChild(option);
                                        });
                                    }

                                    cargarEstadosDisponibles(estadoActual);
                                });
                            </script>


                                    
                                    </div> 


                                    <!-- Segunda fila con campos: Cliente, Sistema, Proyecto y botón de búsqueda -->
                                    <div style="font-size: 12px" class="row row-cols-3 g-3">
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label for="cliente">Cliente</label>
                                    <select class="form-select" style="font-size:12px;" id="ClienteNombre" name="ClienteNombre">


                                                    <option value="-1">...</option>

                                                    @if (nombresClientes != null)
                                                    {
                                                        foreach (var cliente in nombresClientes)
                                                        {

                                                            bool isSelected = cliente.Value == ordentrabajo?.FirstOrDefault()?["Cliente"]?.ToString()?.Trim();
                                                            Console.WriteLine(isSelected);
                                                            if (isSelected)
                                                            {
                                                                <option value="@cliente.Value" selected="selected">@cliente.Value</option>
                                                            }
                                                            else
                                                            {
                                                                <option value="@cliente.Value">@cliente.Value</option>
                                                            }

                                                        }
                                                    }

                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label for="sistema">Sistema</label>
                                                <select class="form-select" style="font-size:12px;" id="SistemaNombre" name="SistemaNombre" d>
                                                    <!-- Opciones(se hace con la db) -->

                                                    <option value="-1">...</option>

                                                    @if (nombresSistemas != null)
                                                    {
                                                        foreach (var sistema in nombresSistemas)
                                                        {


                                                            bool isSelected = sistema.Value == ordentrabajo?.FirstOrDefault()?["Sistema"]?.ToString()?.Trim();
                                                            Console.WriteLine(isSelected);
                                                            if (isSelected)
                                                            {
                                                                <option value="@sistema.Value" selected="selected">@sistema.Value</option>
                                                            }
                                                            else
                                                            {
                                                                <option value="@sistema.Value">@sistema.Value</option>
                                                            }

                                                        }
                                                    }

                                                </select>
                                            </div>
                                        </div>

                            <input type="hidden" id="sistemaSeleccionado" value="@ordentrabajo?.FirstOrDefault()?["Sistema"]?.ToString()?.Trim()" />

                            <script>
                                document.addEventListener("DOMContentLoaded", function () {
                                    const nombresSistemasInput = document.getElementById("nombresSistemas");
                                    const nombresClientesInput = document.getElementById("nombresClientes");
                                    const sistemaSeleccionado = document.getElementById("sistemaSeleccionado")?.value;

                                    let nombresSistemas = {};
                                    let nombresClientes = {};

                                    if (nombresSistemasInput?.value) {
                                        try {
                                            nombresSistemas = JSON.parse(nombresSistemasInput.value);
                                        } catch (e) {
                                            console.error("Error al parsear nombresSistemas:", e);
                                        }
                                    }

                                    if (nombresClientesInput?.value) {
                                        try {
                                            nombresClientes = JSON.parse(nombresClientesInput.value);
                                        } catch (e) {
                                            console.error("Error al parsear nombresClientes:", e);
                                        }
                                    }

                                    const clienteSelect = document.getElementById("ClienteNombre");
                                    const sistemaSelect = document.getElementById("SistemaNombre");

                                    if (!clienteSelect || !sistemaSelect) {
                                        console.warn("Faltan selects 'ClienteNombre' o 'SistemaNombre'");
                                        return;
                                    }

                                    const clienteNombreToId = {};
                                    for (const [id, nombre] of Object.entries(nombresClientes)) {
                                        clienteNombreToId[nombre] = id;
                                    }

                                    clienteSelect.addEventListener("change", function () {
                                        const clienteNombre = this.value;
                                        sistemaSelect.innerHTML = "";

                                        const defaultOption = document.createElement("option");
                                        defaultOption.value = "-1";
                                        defaultOption.text = "...";
                                        sistemaSelect.appendChild(defaultOption);

                                        const clienteId = clienteNombreToId[clienteNombre];

                                        const sistemaIds = clienteId && sistemasPorCliente[clienteId]
                                            ? sistemasPorCliente[clienteId]
                                            : Object.keys(nombresSistemas).map(Number);

                                        sistemaIds.forEach(sid => {
                                            const sidStr = sid.toString();
                                            if (nombresSistemas[sidStr]) {
                                                const option = document.createElement("option");
                                                option.value = nombresSistemas[sidStr];
                                                option.text = nombresSistemas[sidStr];
                                                if (option.value === sistemaSeleccionado) {
                                                    option.selected = true;
                                                }
                                                sistemaSelect.appendChild(option);
                                            }
                                        });
                                    });

                                    // Disparar cambio si ya hay cliente seleccionado
                                    if (clienteSelect.value && clienteSelect.value !== "-1") {
                                        clienteSelect.dispatchEvent(new Event("change"));
                                    }
                                });
                            </script>



                                        <div class="col-md-5">
                                            <div class="form-group">
                                                <label for="proyecto">Proyecto</label>
                                                   <select class="form-select" style="font-size:12px;" id="ProyectoNombre" name="ProyectoNombre">

                                                    @if (nombresProyectos != null)

                                                    {
                                                        <option value="-1">...</option>

                                                        foreach (var proyecto in nombresProyectos)
                                                        {
                                                            var proyectoValue = ordentrabajo?.FirstOrDefault()?["Proyecto"];
                                                            int proyectoId = -1; // Valor por defecto

                                                            if (proyectoValue != null && int.TryParse(proyectoValue.ToString(), out int result))
                                                            {
                                                                proyectoId = result;
                                                            }

                                                            bool isSelected = proyecto.Key == proyectoId;

                                                            if (isSelected)
                                                            {
                                                                <option value="@proyecto.Key" selected="selected">@proyecto.Value</option>
                                                            }
                                                            else
                                                            {
                                                                <option value="@proyecto.Key">@proyecto.Value</option>
                                                            }
                                                        }

                                                    }
                                                </select>
                                            </div>
                                        </div>
                                        @* <div style="font-size: 8px" class="col-md-1 d-flex align-items-end">

                                        <label>@* &nbsp; </label>
                                        <button type="button" class="btn boton">🔍</button>  *@
                                    </div>

                                    <!-- Tercera fila con Usuario Responsable, Usuario Solicitante y Módulo/Pantalla -->
                                    <div style="font-size: 12px" class="row row-cols-3 g-3">
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label for="usuarioResp">Usuario Responsable</label>
                                    <select class="form-select" style="font-size:12px;" id="ResponsableNombre" name="ResponsableNombre">
                                                    <option value="">...</option>

                                                    @if (nombresUsuarios != null)
                                                    {
                                                        foreach (var usuario in nombresUsuarios)
                                                        {

                                                            bool isSelected = usuario.Value == ordentrabajo?.FirstOrDefault()?["UserIDResponsable"]?.ToString()?.Trim();
                                                            Console.WriteLine(isSelected);
                                                            if (isSelected)
                                                            {
                                                                <option value="@usuario.Value" selected="selected">@usuario.Value</option>
                                                            }
                                                            else
                                                            {
                                                                <option value="@usuario.Value">@usuario.Value</option>
                                                            }
                                                        }

                                                    }


                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label for="usuarioSoli">Usuario Solicitante</label>
                                    <select class="form-select" style="font-size:12px;" id="SolicitanteNombre" name="SolicitanteNombre">
                                                    <!-- Opciones(se hace con la db) -->

                                                    <option>...</option>

                                                    @if (nombresUsuarios != null)
                                                    {
                                                        foreach (var usuario in nombresUsuarios)
                                                        {

                                                bool isSelected = usuario.Value == ordentrabajo?.FirstOrDefault()?["UserIDSolicitante"]?.ToString()?.Trim();
                                                            Console.WriteLine(isSelected);
                                                            if (isSelected)
                                                            {
                                                                <option value="@usuario.Value" selected="selected">@usuario.Value</option>
                                                            }
                                                            else
                                                            {
                                                                <option value="@usuario.Value">@usuario.Value</option>
                                                            }
                                                        }
                                                    }

                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-5">
                                            <div class="form-group">
                                                <label for="moduloPantalla">Módulo/Pantalla</label>
                                    <input type="text" class="form-control" style="font-size:12px;" id="Modulo" name="Modulo" placeholder="Ingrese Modulo/Pantalla" value="@ordentrabajo?.FirstOrDefault()?["Modulo"]" />
                                            </div>
                                        </div>
                                    </div>



                                    <!-- Cuarta fila con Asunto y Solicitado Por -->
                                    <div style="font-size: 12px" class="row row-cols-3 g-3">
                                        <div class="col-md-7">
                                                <div class="form-group">
                                                    <label for="Asunto">Asunto</label>
                                                    <input type="text" class="form-control" style="font-size:12px;" id="Asunto" name="Asunto"
                                                           placeholder="Ingrese el asunto"
                                                           value="@ordentrabajo?.FirstOrDefault()?["Asunto"]" />
                                                </div>
                                        </div>
                                        <div class="col-md-5">
                                            <div class="form-group">
                                                <label for="solicitadoPor">Solicitado Por</label>
                                    <select class="form-select" style="font-size:12px;" id="SolicitadoPorNombre" name="SolicitadoPorNombre">
                                                    <!-- Opciones(se hace con la db) -->
                                                    <option>...</option>
                                                    @if (nombresUsuarios != null)
                                                    {
                                                        foreach (var usuario in nombresUsuarios)
                                                        {
                                                            <option value="@usuario.Value">@usuario.Value</option>
                                                        }
                                                    }
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Quinta fila con Horas Facturables, % de Avance, Horas Consumidas, Horas Avances, Nro Implementación y Checkboxes -->
                                    <div style="font-size: 12px" class="row row-cols-3 g-3">

                                        <div class="col-md-2">
                                            <div class="form-group">
                                                <label for="horasFacturables" class="text-nowrap">Hs. Facturables</label>
                                                <input type="number" class="form-control" style="font-size:12px;" id="horasFacturables" placeholder="0"  />
                                            </div>
                                        </div>
                                        <div class="col-md-1">
                                            <div class="form-group">
                                                <label for="porcentajeAvance" class="text-nowrap">% Avance</label>
                                                <input type="number" class="form-control" style="font-size:12px;" id="porcentajeAvance" placeholder="0" min="0" max="100" value="@ordentrabajo?.FirstOrDefault()?["PorcentajeAvance"]"  />
                                            </div>
                                        </div>
                                        <div class="col-md-1">
                                            <div class="form-group">
                                                <label for="horasConsumidas" class="text-nowrap">Hs. Consumo</label>
                                                <input type="number" class="form-control" style="font-size:12px;" id="horasConsumidas" placeholder="0" value="@ordentrabajo?.FirstOrDefault()?["CantidadHorasConsumidas"]"  />
                                            </div>
                                        </div>
                                        <div class="col-md-1">
                                            <div class="form-group">
                                                <label for="horasAvances" class="text-nowrap">Hs. Avances</label>
                                                <input type="number" class="form-control" style="font-size:12px;" id="horasAvances" placeholder="0"  />
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-group">
                                                <label for="NroOtImp" class="text-nowrap">Nro Implementación</label>
                                                <input type="number" class="form-control" style="font-size:12px;" id="NroOtImp" placeholder="0" value="@ordentrabajo?.FirstOrDefault()?["NroOtImplementacion"]" />
                                            </div>
                                        </div>
                                        <div class="row mt-5">
                                            <div class="col-md-4 d-flex align-items-center">
                                                <!-- Primer checkbox -->
                                                <div class="form-check me-3 ">
                                        <input type="checkbox" class="form-check-input" id="PremioPorAvance" name="PremioPorAvance"
                                                           placeholder="0"
                                                           value="@ordentrabajo?.FirstOrDefault()?["PremioPorAvance"]"
                                                           >
                                                    <label class="form-check-label text-nowrap" for="premioAvance">
                                                        Premio por Avance
                                                    </label>
                                                </div>

                                                <!-- Segundo checkbox -->
                                                <div class="form-check me-3 ">
                                                    <input type="checkbox" class="form-check-input" id="alcanceIndefinido"
                                                           value="@ordentrabajo?.FirstOrDefault()?["AlcanceIndefinido"]"
                                                          >
                                                    <label class="form-check-label text-nowrap" for="alcanceIndefinido">
                                                        Alcance Indefinido
                                                    </label>
                                                </div>


                                            </div>
                                        </div>
                                    </div>


                                </div>

                                <div class="row">
                                    <div class="col-10"> </div>
                                    <div class="col-2 d-flex flex-column align-items-end">
                                    </div>
                                </div>
                    


                                @* SEGUNDA PARTE  *@
                                <!--Sección de descripción y accordion-->
                                <!-- Segunda Tarjeta -->
                                <div class="card shadow-sm mb-3">
                                    <div class="card-body">
                                        <!-- Acordeón de Secciones -->
                                        <div id="accordion" class="mt-1">

                                            <!-- Sección de Descripción -->
                                            <div class="card">
                                                <div class="card-header py-1" id="headingDescripcion" style="padding: 1px;">
                                                    <h5 class="mb-0" style="margin: 0; font-size: 1rem;">
                                                        <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapseDescripcion" aria-expanded="true" aria-controls="collapseDescripcion" style="color:white; ">
                                                            <b>  Descripción </b>
                                                        </button>
                                                    </h5>
                                                </div>

                                                <div id="collapseDescripcion" class="collapse show" aria-labelledby="headingDescripcion" data-parent="#accordion">
                                                    <div class="card-body">
                                                        <!-- Barra de herramientas de formato de texto -->
                                                        <div id="descripcion" class="tab-pane fade show active">
                                                            <div class="toolbar">
                                                                <button class="toolbar-btn" disabled><i class="fas fa-undo"></i></button>
                                                                <button class="toolbar-btn" disabled><i class="fas fa-redo"></i></button>
                                                                <select class="toolbar-select"  disabled>
                                                                    <option value="sans-serif">Sans Serif</option>
                                                                    <option value="serif">Serif</option>
                                                                    <option value="monospace">Monospace</option>
                                                                </select>
                                                                <button class="toolbar-btn" disabled><i class="fas fa-bold"></i></button>
                                                                <button class="toolbar-btn" disabled><i class="fas fa-italic"></i></button>
                                                                <button class="toolbar-btn" disabled><i class="fas fa-underline"></i></button>
                                                                <button class="toolbar-btn" disabled><i class="fas fa-align-left"></i></button>
                                                                <button class="toolbar-btn" disabled><i class="fas fa-align-center"></i></button>
                                                                <button class="toolbar-btn" disabled><i class="fas fa-align-right"></i></button>
                                                                <button class="toolbar-btn" disabled><i class="fas fa-list-ul"></i></button>
                                                                <button class="toolbar-btn" disabled><i class="fas fa-list-ol"></i></button>
                                                            </div>
                                                        </div>
                                            <textarea class="form-control descripcion-textarea" rows="5" style="height:170px;"
                                                      id="Descripcion" name="Descripcion"
                                                      placeholder="Escribe la descripción aquí...">@ordentrabajo?.FirstOrDefault()?["DescripcionPlano"]</textarea>
                                                        <small class="form-text text-muted"> Incluye una descripción general del trabajo o la tarea.</small>
                                                    </div>
                                                </div>
                                            </div>

                                          <!-- Sección de Avances de Trabajo -->
                                            <div class="card">
                                                <div class="card-header" id="headingAvances" style="padding: 3px;">
                                                    <h5 class="mb-0" style="margin: 0; font-size: 1rem;">
                                                        <button class="btn btn-link collapsed" type="button" data-toggle="collapse"
                                                                data-target="#collapseAvances" aria-expanded="false" aria-controls="collapseAvances"
                                                                style="color:white;">
                                                            <b>Avances de Trabajo</b>
                                                        </button>
                                                    </h5>
                                                </div>

                                    <div id="collapseAvances" class="collapse" aria-labelledby="headingAvances" data-parent="#accordion">
                                        <div class="card-body">

                                            <h5>Avances Registrados (Solo Lectura)</h5>
                                            <table class="table table-bordered table-sm table-striped mb-3">
                                                <thead>
                                                    <tr>
                                                        <th>ID</th>
                                                        <th>Descripción</th>
                                                        <th>Tipo Avance</th>
                                                        <th>Fecha</th>
                                                        <th>Usuario Alta</th>
                                                        <th>Horas Insumidas</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @if (avancesTrabajo != null && avancesTrabajo.Any())
                                                    {
                                                        foreach (var avance in avancesTrabajo)
                                                        {
                                                            <tr>
                                                                <td>@avance.AvanceTrabajoId</td>
                                                                <td>@avance.Descripcion</td>
                                                                <td>@(string.IsNullOrEmpty(avance.TipoAvance) ? "Desarrollo" : avance.TipoAvance)</td>
                                                                <td>@avance.Fecha.ToString("dd/MM/yyyy")</td>
                                                                <td>@avance.UserIDAlta</td>
                                                                <td>@avance.HorasInsumidas</td>
                                                            </tr>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        <tr><td colspan="6">No hay avances registrados.</td></tr>
                                                    }
                                                </tbody>
                                            </table>

                                            <h5>Agregar Nuevos Avances</h5>
                                            <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ccc;">
                                                <table id="tablaAvances" class="table table-bordered table-sm table-striped">
                                                    <thead>
                                                        <tr>
                                                            <th>Descripción</th>
                                                            <th>Tipo Avance</th>
                                                            <th>Fecha</th>
                                                            <th>Horas (hs)</th>
                                                            <th>Acción</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <!-- VACÍO, solo se agregan filas nuevas con JS -->
                                                    </tbody>
                                                </table>
                                            </div>

                                            <button class="btn btn-primary btn-sm" type="button" onclick="agregarAvance()">Agregar Avance</button>

                                        </div>
                                    </div>

                                    <!-- Template oculto para agregar nuevas filas -->
                                    <script type="text/template" id="avance-template">
                                        <tr data-index="{i}">
                                            <td><input type="text" name="Avances[{i}].Descripcion" class="form-control" required /></td>
                                            <td>  <input type="number" name="Avances[{i}].TipoAvance" class="form-control" value="9"  readonly/></td>
                                            <td><input type="date" name="Avances[{i}].Fecha" class="form-control" required /></td>
                                            <td><input type="number" name="Avances[{i}].HorasInsumidas" class="form-control" step="0.01" required /></td>
                                            <td>
                                                <button type="button" class="btn btn-danger btn-sm" onclick="eliminarAvance(this)">🗑️</button>
                                                <input type="hidden" name="Avances[{i}].UserIDAlta" value="@User.Identity.Name" />
                                                <input type="hidden" name="Avances[{i}].FechaAlta" value="@DateTime.Now.ToString("yyyy-MM-dd")" />
                                            </td>
                                        </tr>
                                    </script>

                                    <script>
                                        let avanceIndex = 0;

                                        function agregarAvance() {
                                            const template = document.getElementById('avance-template').innerHTML;
                                            const nuevo = template.replaceAll('{i}', avanceIndex);
                                            document.querySelector('#tablaAvances tbody').insertAdjacentHTML('beforeend', nuevo);
                                            avanceIndex++;
                                        }

                                        function eliminarAvance(btn) {
                                            const fila = btn.closest('tr');
                                            fila.remove();
                                        }
                                    </script>


                                
                                            <!-- Sección de Puesta en Producción -->
                                            <div class="card">
                                                <div class="card-header" id="headingProduccion" style="padding: 3px;">
                                                    <h5 class="mb-0" style="margin: 0; font-size: 1rem;">
                                                        <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseProduccion" aria-expanded="false" aria-controls="collapseProduccion" style="color:white;">
                                                            <b> Puesta en Producción </b>
                                                        </button>
                                                    </h5>
                                                </div>
                                                <div id="collapseProduccion" class="collapse" aria-labelledby="headingProduccion" data-parent="#accordion">
                                                    <div class="card-body">
                                                        <select class="form-select mb-3" id="tipoModificacion" name="tipoModificacion">

                                                    <option value="formulario" selected>Formulario</option>
                                                            <option value="baseDatos">Base de Datos</option>
                                                        </select>
                                                        <textarea class="form-control" id="modificacionDetalle" name="modificacionDetalle" style="height: 200px; " rows="3" placeholder="..."></textarea>

                                                <input type="hidden" id="FormulariosModificados" name="FormulariosModificados" value="@ordentrabajo?.FirstOrDefault()?["FormulariosModificadosPlano"]" />
                                                <input type="hidden" id="ModificacionesBaseDatos" name="ModificacionesBaseDatos" value="@ordentrabajo?.FirstOrDefault()?["ModificacionesBaseDatosPlano"]" />


                                                        <small class="form-text text-muted">Selecciona el tipo de modificación que se hará en producción.</small>
                                                <script>
                                                    document.addEventListener("DOMContentLoaded", function () {
                                                        const tipoSelect = document.getElementById("tipoModificacion");
                                                        const detalleTextArea = document.getElementById("modificacionDetalle");

                                                        const formularioInput = document.getElementById("FormulariosModificados");
                                                        const baseDatosInput = document.getElementById("ModificacionesBaseDatos");

                                                        // Inicializar valores actuales desde los input hidden
                                                        let formularioTexto = formularioInput.value || "";
                                                        let baseDatosTexto = baseDatosInput.value || "";

                                                        // Forzar selección por defecto en "formulario" y mostrar su contenido
                                                        tipoSelect.value = "formulario";
                                                        detalleTextArea.value = formularioTexto;

                                                        tipoSelect.addEventListener("change", function () {
                                                            const valorActual = detalleTextArea.value;

                                                            if (this.value === "formulario") {
                                                                baseDatosTexto = valorActual;
                                                                detalleTextArea.value = formularioTexto;
                                                            } else if (this.value === "baseDatos") {
                                                                formularioTexto = valorActual;
                                                                detalleTextArea.value = baseDatosTexto;
                                                            } else {
                                                                detalleTextArea.value = "";
                                                            }
                                                        });

                                                        detalleTextArea.addEventListener("input", function () {
                                                            if (tipoSelect.value === "formulario") {
                                                                formularioTexto = detalleTextArea.value;
                                                            } else if (tipoSelect.value === "baseDatos") {
                                                                baseDatosTexto = detalleTextArea.value;
                                                            }
                                                        });

                                                        const form = detalleTextArea.closest("form");
                                                        form.addEventListener("submit", function () {
                                                            if (tipoSelect.value === "formulario") {
                                                                formularioInput.value = detalleTextArea.value;
                                                            } else if (tipoSelect.value === "baseDatos") {
                                                                baseDatosInput.value = detalleTextArea.value;
                                                            }

                                                            if (!formularioInput.value && formularioTexto) {
                                                                formularioInput.value = formularioTexto;
                                                            }

                                                            if (!baseDatosInput.value && baseDatosTexto) {
                                                                baseDatosInput.value = baseDatosTexto;
                                                            }
                                                        });
                                                    });
                                                </script>




                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Sección de Archivo Adjunto -->
                                            <div class="card">
                                                <div class="card-header" id="headingArchivo" style="padding: 3px;">
                                                    <h5 class="mb-0" style="margin: 0; font-size: 1rem;">
                                                        <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseArchivo" aria-expanded="false" aria-controls="collapseArchivo" style="color:white;">
                                                            <b> Archivo Adjunto </b>
                                                        </button>
                                                    </h5>
                                                </div>
                                                <div id="collapseArchivo" class="collapse" aria-labelledby="headingArchivo" data-parent="#accordion">
                                                    <div class="card-body" style="max-height: 280px; overflow-y: auto;">
                                                        <div class="table-responsive">
                                                            <table class="table table-bordered">
                                                                <thead>
                                                                    <tr>
                                                                        <th>Número</th>
                                                                        <th>Nombre</th>
                                                                        <th>Fecha de Alta</th>
                                                                        <th>Usuario Alta</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    @if (adjuntos != null && adjuntos.Any())
                                                                    {
                                                                        foreach (var item in adjuntos)
                                                                        {
                                                                            <tr>
                                                                                <td>@item.CorrelativoAdjunto</td>
                                                                                <td>@item.NombreArchivo</td>
                                                                                <td>@item.FechaAlta.ToString("dd/MM/yyyy")</td>
                                                                                <td>@item.UserID</td>
                                                                            </tr>

                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        <tr>
                                                                            <td colspan="4">No hay archivos adjuntos para esta orden.</td>
                                                                        </tr>
                                                                    }
                                                                </tbody>
                                                            </table>
                                                        </div>

                                                        <form asp-controller="Files" asp-action="UploadFiles" enctype="multipart/form-data" method="post">
                                                            <div>
                                                                <label for="files">Selecciona archivos:</label>
                                                                <input type="file" id="files" name="files" multiple />
                                                            </div>
                                                             <button class="btn boton btn-sm" type="submit">Subir Archivos</button> 
                                                        </form>

                                            

                                                        <button class="btn btn-danger btn-sm">Quitar</button> 
                                                        <small class="form-text text-muted">Carga o elimina un archivo relacionado.</small>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Sección de Historial de Estado -->
                                            <div class="card">
                                                <div class="card-header" id="headingHistorial" style="padding: 3px;">
                                                    <h5 class="mb-0" style="margin: 0; font-size: 1rem;">
                                                        <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseHistorial" aria-expanded="false" aria-controls="collapseHistorial" style="color:white;">
                                                            <b> Historial de Estado </b>
                                                        </button>
                                                    </h5>
                                                </div>
                                                    <div id="collapseHistorial" class="collapse" aria-labelledby="headingHistorial" data-parent="#accordion">
                                                        <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                                                            <div class="table-responsive" style="height: 200px;">
                                                                <table class="table table-bordered" id="tablaHistorial">
                                                                    <thead>
                                                                        <tr>
                                                                            <th>Secuencia</th>
                                                                            <th>Estado del Trabajo</th>
                                                                            <th>Fecha</th>
                                                                            <th>Hora</th>
                                                                            <th>Usuario</th>
                                                                          
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody id="cuerpoHistorial">
                                                                        @if (historial != null && historial.Any())
                                                                        {
                                                                            int secuencia = 1;
                                                                            foreach (var estado in historial)
                                                                            {
                                                                                <tr>
                                                                                    <td>@secuencia</td>
                                                                                    <td>@estado.Descripcion</td>
                                                                                    <td>@estado.FechaAlta.ToString("dd/MM/yyyy")</td>
                                                                                    <td>@estado.FechaAlta.ToString("HH:mm")</td>
                                                                                    <td>@estado.UserID</td>
                                                                                  
                                                                                </tr>
                                                                                secuencia++;
                                                                            }
                                                                        }
                                                                        else
                                                                        {
                                                                            <tr>
                                                                                <td colspan="6">No hay historial para esta orden.</td>
                                                                            </tr>
                                                                        }
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                        <div class="card-body">
                                                            <div id="estadosNuevos"></div>
                                                            @* <button type="button" class="btn btn-sm btn-primary" onclick="agregarEstado()">Agregar Estado</button>  *@
                                                            <small class="form-text text-muted">Mantén un registro de los estados por los que ha pasado esta tarea.</small>
                                                        </div>
                                                    </div>

                                                    <!-------------------------HISTORIAL ESTADOS----------------------------->
                                     
                                                       @*  <script>
                                                            let secuencia = @((historial != null && historial.Any()) ? historial.Count + 1 : 1);

                                                            const estados = [
                                                                "PENDIENTE", "ENTREGADO", "EN DESARROLLO", "TERMINADO", "EN PRODUCCION",
                                                                "FACTURADA", "BONIFICADA", "PRESUPUESTO ENVIADO AL CLIENTE", "PRUEBA REALIZADA OK",
                                                                "PARA REVISAR PROBLEMAS EN LAS PRUEBAS", "PRESUPUESTO APROBADO",
                                                                "PRESUPUESTO ASIGNADO", "PRESUPUESTO NO APROBADO", "FACTURADA (INCLUIDA ABONO)",
                                                                "EN PROCESO DE PRESUPUESTO", "PRESUPUESTO FACTURADO", "INCLUIDA EN VERSION", "ANULADA"
                                                            ];

                                                            const usuarios = [
                                                                "JALMADA", "JGARZA", "ATRONCOSO", "JURIBE", "RHERRERA", "MVERA", "AVICENTE",
                                                                "FFONTANINI", "SANGELOFF", "JSANDOVAL", "SSORIA", "FBEQUIR", "FFIORE", "ERUIZ",
                                                                "DDELCOLLAD", "CNAVARRO"
                                                            ];

                                                            function agregarEstado() {
                                                                const tbody = document.getElementById("cuerpoHistorial");
                                                                const tr = document.createElement("tr");

                                                                const hoy = new Date().toISOString().split("T")[0];
                                                                const hora = new Date().toTimeString().substring(0, 5);

                                                                tr.innerHTML = `
                                                                    <td>${secuencia}</td>
                                                                    <td>
                                                                        <select name="EstadosNuevos[${secuencia - 1}].Descripcion" class="form-control form-control-sm">
                                                                            ${estados.map(e => `<option value="${e}">${e}</option>`).join('')}
                                                                        </select>
                                                                    </td>
                                                                    <td>
                                                                        <input type="date" name="EstadosNuevos[${secuencia - 1}].Fecha" class="form-control form-control-sm" value="${hoy}" />
                                                                    </td>
                                                                    <td>
                                                                        <input type="time" name="EstadosNuevos[${secuencia - 1}].Hora" class="form-control form-control-sm" value="${hora}" />
                                                                    </td>
                                                                    <td>
                                                                        <select name="EstadosNuevos[${secuencia - 1}].UserID" class="form-control form-control-sm">
                                                                            ${usuarios.map(u => `<option value="${u}">${u}</option>`).join('')}
                                                                        </select>
                                                                    </td>
                                                                    <td>
                                                                        <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('tr').remove();">X</button>
                                                                    </td>
                                                                `;
                                                                tbody.appendChild(tr);
                                                                secuencia++;
                                                            }
                                                        </script> *@
                                        

                                                    <!-------------------------HISTORIAL ESTADOS----------------------------->
                                            </div>

                                        </div>
                                    </div>
                                </div>
                              

                                <!-- Botones de acciones -->
                        <div class="row mt-2">
                            <div class="col-md-12 d-flex justify-content-between align-items-center" style="font-size:12px;">
                                <!-- Agrupación de otros botones -->
                                <div class="grupo-botones" style="font-size:12px;">
                                    @* <button class="btn boton" disabled>Copiar Orden</button>
                                            <button class="btn boton" disabled>Enviar Orden</button>
                                            <a class="btn boton" asp-area="" asp-controller="ABM" asp-action="VistaIndividual">Agregar</a>
                                            <button type="button" class="btn boton" onclick="modificarOrden()">Modificar</button> *@
                                    <button type="submit" class="btn btn-primary" id="btnGrabar">
                                        Grabar (Actualizar Orden)
                                        <span id="btnSpinner" class="spinner-border spinner-border-sm ms-2" role="status" aria-hidden="true" style="display:none;"></span>
                                    </button>

                                    <button type="button" class="btn boton-cancelar"
                                            onclick="window.location.href='@Url.Action("VistaIndividualModificar", new { orden = @nroOrden })';">
                                        Cancelar
                                    </button>
                                    <!-- Estilo diferente para cancelar -->
                                </div>
                            </div>
                        </div>
                </form>

                <script>
                    function modificarOrden() {
                      const nroOrden = document.getElementById('orden').value;
                      if (nroOrden) {
                        // Redirige a la acción pasando el nro de orden
                        window.location.href = '@Url.Action("VistaIndividualModificar", "ABM")?orden=' + nroOrden;
                      } else {
                        alert('Por favor ingrese un número de orden válido');
                      }
                    }
                </script>



            </div>
        </div>
    </div>
</div>
</div>